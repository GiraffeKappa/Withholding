<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://script.google.com/macros/s/AKfycbxOoChdDn60hAjg6TLPGYIRR6EcU3nxbDvlmYVSj8BEhPBQI1ccUM9iUgjOekVwhVVy/exec" rel="stylesheet">
    <style>
      body { padding: 20px; background-color: #f8f9fa; }
      .container { max-width: 600px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
      .readonly-input { background-color: #e9ecef; pointer-events: none; }
    </style>
  </head>
  <body>
    <div class="container">
      <h3 class="mb-4 text-center">廠商代扣繳登錄 v4</h3>
      
      <form id="myForm" onsubmit="handleFormSubmit(this)">
        
        <div class="mb-3">
          <label class="form-label">廠商/個人名稱</label>
          <input type="text" class="form-control" name="vendor" required>
        </div>

        <div class="mb-3">
          <label class="form-label d-block">身分別 (影響稅率)</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="residency" id="local" value="本國人" checked onchange="updateSuggestedRate()">
            <label class="form-check-label" for="local">本國人 (居住者)</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="residency" id="foreign" value="外國人" onchange="updateSuggestedRate()">
            <label class="form-check-label" for="foreign">外國人 (非居住者)</label>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">給付項目</label>
          <select class="form-select" id="item" name="item" onchange="updateSuggestedRate()">
            <option value="薪資">薪資 (50)</option>
            <option value="執行業務所得">執行業務所得 (9A)</option>
            <option value="稿費">稿費/演講費 (9B)</option>
            <option value="競技競賽">競技競賽機會中獎</option>
            <option value="其他所得">其他所得 (免稅)</option>
          </select>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">給付金額</label>
            <input type="number" class="form-control" id="grossAmount" name="grossAmount" oninput="syncTaxable()" required>
          </div>
           <div class="col-md-6 mb-3">
            <label class="form-label">應稅金額</label>
            <input type="number" class="form-control" id="taxableAmount" name="taxableAmount" oninput="calculate()" required>
            <div class="form-text" style="font-size: 12px;">預設同給付金額</div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">代扣稅率 (%)</label>
            <input type="number" class="form-control" id="taxRatePercent" oninput="manualRateChange()" step="0.1" placeholder="例如 10">
            <input type="hidden" id="taxRate" name="taxRate"> 
            <div class="form-text">可手動修改數值</div>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">代扣稅額</label>
            <input type="number" class="form-control readonly-input" id="tax" name="tax" readonly>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">實付金額</label>
          <input type="number" class="form-control fw-bold readonly-input" id="net" name="net" readonly>
        </div>

        <div class="mb-3">
          <label class="form-label">上傳憑證 (圖片/PDF)</label>
          <input type="file" class="form-control" name="myFile" id="fileInput">
        </div>

        <div class="mb-3">
          <label class="form-label">備註</label>
          <input type="text" class="form-control" name="note">
        </div>

        <button type="submit" class="btn btn-primary w-100" id="submitBtn">送出資料</button>
      </form>
      
      <div id="message" class="mt-3 text-center text-success"></div>
    </div>

    <script>
      // ★★★ 稅率規則表 (Matrix) ★★★
      // 你可以在這裡調整預設的自動判斷邏輯
      const taxRules = {
        "本國人": {
          "薪資": 5,           // 5%
          "執行業務所得": 10,  // 10%
          "稿費": 10,          // 10%
          "競技競賽": 10,
          "其他所得": 0
        },
        "外國人": {
          "薪資": 18,          // 外國人薪資通常較高 (18% 或 6%)
          "執行業務所得": 20,  // 20%
          "稿費": 20,          // 20%
          "競技競賽": 20,
          "其他所得": 0
        }
      };

      window.onload = function() {
        updateSuggestedRate();
      };

      function syncTaxable() {
        var gross = document.getElementById('grossAmount').value;
        document.getElementById('taxableAmount').value = gross;
        calculate();
      }

      // 核心功能：根據 身分+項目 自動帶出稅率
      function updateSuggestedRate() {
        // 1. 取得身分
        var residency = document.querySelector('input[name="residency"]:checked').value;
        // 2. 取得項目
        var item = document.getElementById('item').value;
        
        // 3. 查表找稅率 (如果找不到預設為 0)
        var ratePercent = 0;
        if (taxRules[residency] && taxRules[residency][item] !== undefined) {
          ratePercent = taxRules[residency][item];
        }

        // 4. 更新畫面上的稅率欄位
        document.getElementById('taxRatePercent').value = ratePercent;
        
        // 5. 觸發計算
        manualRateChange();
      }

      // 當使用者手動改稅率，或是自動帶入稅率後，都要執行這裡
      function manualRateChange() {
        var percent = parseFloat(document.getElementById('taxRatePercent').value) || 0;
        // 更新隱藏的實際計算用稅率 (例如顯示 10，實際是 0.1)
        document.getElementById('taxRate').value = percent / 100;
        calculate();
      }

      function calculate() {
        var gross = parseFloat(document.getElementById('grossAmount').value) || 0;
        var taxable = parseFloat(document.getElementById('taxableAmount').value) || 0;
        var rate = parseFloat(document.getElementById('taxRate').value) || 0;
        
        // 計算稅額 (四捨五入)
        var tax = Math.round(taxable * rate);
        var net = gross - tax;

        document.getElementById('tax').value = tax;
        document.getElementById('net').value = net;
      }

      function handleFormSubmit(formObject) {
        event.preventDefault();
        var btn = document.getElementById('submitBtn');
        var msg = document.getElementById('message');
        
        btn.disabled = true;
        btn.innerText = "資料處理中...";
        msg.innerText = "";

        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];
        
        var reader = new FileReader();
        reader.onload = function(e) {
          var fileData = {
            filename: file ? file.name : "",
            mimeType: file ? file.type : "",
            bytes: file ? [...new Int8Array(e.target.result)] : []
          };
          
          var formData = {
            vendor: formObject.vendor.value,
            residency: formObject.residency.value, // 傳送身分
            item: formObject.item.value,
            grossAmount: formObject.grossAmount.value,
            taxableAmount: formObject.taxableAmount.value,
            taxRate: document.getElementById('taxRatePercent').value + "%", // 存成 "10%" 的格式比較好看
            tax: formObject.tax.value,
            net: formObject.net.value,
            note: formObject.note.value,
            myFile: file ? fileData : null
          };

          google.script.run.withSuccessHandler(function(response) {
            formObject.reset();
            // 重置後要記得把預設選項勾回來，並重新計算
            document.getElementById('local').checked = true;
            updateSuggestedRate();
            
            btn.disabled = false;
            btn.innerText = "送出資料";
            msg.innerText = response;
          }).processForm(formData);
        };
        
        if (file) {
          reader.readAsArrayBuffer(file);
        } else {
          reader.onload({target: {result: null}});
        }
      }
    </script>
  </body>

</html>
